<!DOCTYPE html>
<html>
<head>
<style>

h1, h2, h3, div {
	font-family: arial, sans-serif;
}

table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 100%;
}

td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
}

tr:nth-child(even) {
    background-color: #dddddd;
}
</style>
</head>

<script src="../assets/angular/angular.min.js"></script>
<script src="../assets/angular/i18n/angular-locale_it-it.js"></script>

<body>

<div ng-app="auctionAppp" ng-controller="auctionCtrl">

	<h1>Aste S.p.A. - Piattaforma Aste Online</h1>
	
	<h2>Benvenuto {{userProfile.username + " (" + userProfile.email + ")"}}</h2>
	
	<h3>Aste attive</h3>

	<table>
	  <tr>
	    <th>Titolo</th>
	    <th>Descrizione</th>
	    <th>Data Inizio</th>
	    <th>Data Fine</th>
	    <th>Azioni</th>
	  </tr>	  
	  
	  <tr ng-repeat="auction in auctions">
	    <td>{{auction.title}}</td>
	    <td>{{auction.description}}</td>
	    <td>{{auction.startAuction | date:'dd/MM/yyyy HH:mm:ss'}}</td>
	    <td>{{auction.endAuction | date:'dd/MM/yyyy HH:mm:ss'}}</td>
	    <td><button ng-click="loadAuction(auction.oid)">seleziona</button></td>
	  </tr>
	 
	</table>
	
	<div ng-if="selectedAuction">
	
		<h3>Asta Selezionata: {{selectedAuction.oid}}</h3>		
		
		<table>
		
		 <tr>
		    <th>Titolo</th>
		    <td>{{selectedAuction.title}}</th>
		  </tr>
		  
		  <tr>
		    <th>Descrizione</th>
		    <td>{{selectedAuction.description}}</th>
		  </tr>
		  
		  <tr>
		    <th>Attuale migliore offerta ({{selectedAuction.pricing}})</th>
		    <td>{{selectedAuction.currentWinningPrice | currency}}</td>
		  </tr>
		  
		  <tr>
		    <th>Fai un'offerta</th>
		    <td>
		    	<input type="text" name="bidPrice" 
		    	placeholder="{{selectedAuction.currentWinningPrice}}"
       			ng-model="bidPrice" currency-mask />
		    	<button ng-click="addBid(bidPrice)">conferma</button>
		    </td>
		  </tr>
		  
		  <tr>
		  	<th>Abbonamento a canali di notifica</th>
		  	<td>
		  		<div>
		  			<span>notifiche push sul browser:</span>
		  			<button ng-if="!websocketChannelActive" ng-click="registerChannel('WEBSOCKET')">registrati</button>
		  			<button ng-if="websocketChannelActive" ng-click="deregisterChannel('WEBSOCKET')">annulla registrazione</button>
		  		</div>
		  		<div>
		  			<span>notifiche via email: </span>
		  			<button ng-if="!emailChannelActive" ng-click="registerChannel('EMAIL')">registrati</button>		  
		  			<button ng-if="emailChannelActive" ng-click="deregisterChannel('EMAIL')">annulla registrazione</button>
		  		</div>		  	
		  	</td>
		  </tr>
		  
		  <tr>
		    <th>Data Inizio</th>
		    <td>{{selectedAuction.startAuction | date:'dd/MM/yyyy HH:mm:ss'}}</td>
		  </tr>		  
		  <tr>
		    <th>Data Fine</th>
		    <td>{{selectedAuction.endAuction | date:'dd/MM/yyyy HH:mm:ss'}}</td>
		  </tr>
		  <tr>
		    <th>Prodotto</th>
		    <td>{{selectedAuction.product.descrition}}</td>
		  </tr>
		  <tr>
		  	<th>Fornitore</th>
		  	<td>{{selectedAuction.supplier.info}} - {{selectedAuction.supplier.email}} - ({{selectedAuction.supplier.address.postCode}}) {{selectedAuction.supplier.address.address}} {{selectedAuction.supplier.address.city}}</td>
		  </tr>
		  
		  <tr ng-repeat="imageOid in selectedAuction.productImages">
		  	<th>Immagine</th>
		  	<td><img src="../rest/auction/getImage/{{selectedAuction.oid}}/{{imageOid}}" /></td>
		  </tr>
		   
		</table>
	
	</div>
	

</div>


<script>
var app = angular.module('auctionAppp', []);


app.controller('auctionCtrl', function($scope, $http, $interval) {
	
	
	$scope.loadUserProfile = function(){
		var response = $http.get('../rest/user/get');
		
		response.success(function(data, status, headers, config) {
			 $scope.userProfile = data;
		});
		
	};
	
	$scope.loadAuctions = function(){
		var response = $http.get('../rest/auction/list');
		
		response.success(function(data, status, headers, config) {
			 $scope.auctions = data;
		});
		
	};
	
	$scope.loadAuction = function(oid){
		var response = $http.get('../rest/auction/get/' + oid);
		
		response.success(function(data, status, headers, config) {
			 $scope.selectedAuction = data;
		});
		
		var response2 = $http.get('../rest/auction/activeChannels/' + oid);
		response2.success(function(data, status, headers, config) {
			
			var websocketChannelActive = false;
			var emailChannelActive = false;
			 
 			for (var i = 0; i < data.length; i++) {
 			     if(data[i].type == 'WEBSOCKET'){
					  alert(channel.type)
					  websocketChannelActive = true;
				  } else if(data[i].type == 'EMAIL'){
					  emailChannelActive = true; 
				  }
 			}
			
			 $scope.websocketChannelActive = websocketChannelActive;
			 $scope.emailChannelActive = emailChannelActive;
		});	
		
	};
	
	$scope.addBid = function(bidPrice){
		
		var parameter = JSON.stringify({auctionOid:$scope.selectedAuction.oid, 
		auctionVersion:$scope.selectedAuction.version, price:bidPrice});
		
		var response = $http.post('../rest/auction/addBid/',parameter);
		
		response.success(function(data, status, headers, config) {
			alert("offerta inserita correttamente");
			$scope.loadAuction($scope.selectedAuction.oid);
		});
		
		 response.error(function(data, status, headers, config) {
	            alert("Non e' stato possibile inserire l'offerta: " + data.messages);
	        });
		
		
	} 
	
	$scope.registerChannel = function(channelType){
		
		var parameter = JSON.stringify({auctionOid:$scope.selectedAuction.oid, type:channelType});
		
		var response = $http.post('../rest/auction/registerChannel/',parameter);
		
		response.success(function(data, status, headers, config) {
			alert("registrazione al canale eseguita");
			$scope.loadAuction($scope.selectedAuction.oid);
		});
		
	} 
	
	$scope.deregisterChannel = function(channelType){
		
		var parameter = JSON.stringify({auctionOid:$scope.selectedAuction.oid, type:channelType});
		
		var response = $http.post('../rest/auction/deregisterChannel/',parameter);
		
		response.success(function(data, status, headers, config) {
			alert("deregistrazione al canale eseguita");
			$scope.loadAuction($scope.selectedAuction.oid);
		});
		
	} 
	
	
	//initial load
	$scope.loadUserProfile();	
	$scope.loadAuctions();	
	
	//refresh data every 5 seconds
	//$interval( function(){ $scope.loadUserProfile(); $scope.loadAuctions(); $scope.loadAuctions(selectedAuction.oid);}, 5000);
    
});


</script>

</body>
</html>